<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Trading Bot Pro - Enhanced Edition</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Enhanced CSS Styles with Better Colors -->
    <style>
        :root {
            /* Enhanced Color Palette */
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --primary-light: #EEF2FF;
            --success-color: #10B981;
            --success-hover: #059669;
            --danger-color: #EF4444;
            --danger-hover: #DC2626;
            --warning-color: #F59E0B;
            --warning-hover: #D97706;
            --info-color: #3B82F6;
            --info-hover: #2563EB;
            --dark-bg: #0F172A;
            --light-bg: #F8FAFC;
            --card-bg: #FFFFFF;
            --border-color: #E2E8F0;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%239C92AC" fill-opacity="0.05"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E') repeat;
            z-index: -1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 25px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .tab-button {
            flex: 1;
            padding: 16px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid transparent;
            min-width: 130px;
            color: var(--text-secondary);
            position: relative;
        }

        .tab-button:hover {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border-bottom-color: var(--success-color);
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.1);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--success-color);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        .tab-content {
            display: none;
            background: var(--card-bg);
            padding: 35px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            animation: fadeIn 0.4s ease-in-out;
            border: 1px solid var(--border-color);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .form-control.error {
            border-color: var(--danger-color);
            background-color: #FEF2F2;
        }

        /* Enhanced Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-right: 10px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), var(--success-hover));
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-hover));
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), var(--warning-hover));
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), var(--info-hover));
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .section {
            background: linear-gradient(135deg, #f6f8fb, #ffffff);
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 20px;
        }

        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            border-radius: 2px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 20px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
        }

        .status-online {
            background: linear-gradient(135deg, var(--success-color), var(--success-hover));
            color: white;
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: linear-gradient(135deg, var(--danger-color), var(--danger-hover));
            color: white;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }

        .console {
            background: linear-gradient(135deg, #1a1f2e, #0f172a);
            color: #E0E6ED;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .console-input {
            display: flex;
            gap: 10px;
        }

        .console-input input {
            flex: 1;
            background: linear-gradient(135deg, #2a2f3e, #1f2937);
            color: #E0E6ED;
            border: 2px solid rgba(79, 70, 229, 0.3);
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            border-radius: 8px;
        }

        .console-input input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 10px;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        .table th,
        .table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: linear-gradient(135deg, var(--primary-light), white);
            font-weight: 600;
            color: var(--primary-color);
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }

        .table tbody tr {
            transition: all 0.2s;
        }

        .table tbody tr:hover {
            background: var(--primary-light);
            transform: scale(1.01);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--primary-light);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .checkbox-wrapper:hover {
            background: linear-gradient(135deg, var(--primary-light), white);
            box-shadow: var(--shadow-sm);
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .radio-wrapper {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .radio-wrapper:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .radio-wrapper input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }

        .radio-wrapper input[type="radio"]:checked + label {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* Enhanced Alert Styles */
        .alert {
            padding: 16px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            position: relative;
            border: 1px solid;
            font-size: 14px;
            line-height: 1.5;
        }

        .alert::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 10px 0 0 10px;
        }

        .alert-info {
            background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
            color: #1E40AF;
            border-color: #93C5FD;
        }

        .alert-info::before {
            background: var(--info-color);
        }

        .alert-warning {
            background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
            color: #92400E;
            border-color: #FCD34D;
        }

        .alert-warning::before {
            background: var(--warning-color);
        }

        .alert-danger {
            background: linear-gradient(135deg, #FEF2F2, #FEE2E2);
            color: #991B1B;
            border-color: #FCA5A5;
        }

        .alert-danger::before {
            background: var(--danger-color);
        }

        .alert-success {
            background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
            color: #166534;
            border-color: #86EFAC;
        }

        .alert-success::before {
            background: var(--success-color);
        }

        .loader {
            border: 3px solid rgba(79, 70, 229, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s;
            box-shadow: var(--shadow-xl);
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h2 {
            color: var(--primary-color);
            font-size: 24px;
        }

        .modal-close {
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: var(--danger-color);
            background: var(--danger-color);
            color: white;
            transform: rotate(90deg);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }

            .tab-button {
                font-size: 13px;
                padding: 12px 8px;
            }

            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8rem;
            }
        }

        .scrollable-frame {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .scrollable-frame::-webkit-scrollbar {
            width: 10px;
        }

        .scrollable-frame::-webkit-scrollbar-track {
            background: var(--primary-light);
            border-radius: 5px;
        }

        .scrollable-frame::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 5px;
        }

        .scrollable-frame::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover);
        }

        /* Console message types with better colors */
        .console-error { color: #FF6B6B; }
        .console-warning { color: #FFD43B; }
        .console-info { color: #74C0FC; }
        .console-success { color: #51CF66; }
        .console-debug { color: #ACB5BD; }
        .console-telethon { color: #FAB005; }
        .console-auth { color: #FF8CC8; }

        /* Notification animations */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            padding: 16px 20px;
            border-radius: 10px;
            animation: slideInNotification 0.3s ease-out;
            box-shadow: var(--shadow-xl);
            border-left: 4px solid;
            backdrop-filter: blur(10px);
        }

        @keyframes slideInNotification {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutNotification {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Risk Management Indicators */
        .risk-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-light), white);
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }

        .risk-indicator:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .risk-level-safe {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #F0FDF4, white);
        }

        .risk-level-warning {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, #FFFBEB, white);
        }

        .risk-level-danger {
            border-color: var(--danger-color);
            background: linear-gradient(135deg, #FEF2F2, white);
        }

        .risk-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .risk-bar-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .risk-bar-fill.safe {
            background: linear-gradient(90deg, var(--success-color), var(--success-hover));
        }

        .risk-bar-fill.warning {
            background: linear-gradient(90deg, var(--warning-color), var(--warning-hover));
        }

        .risk-bar-fill.danger {
            background: linear-gradient(90deg, var(--danger-color), var(--danger-hover));
        }

        /* Margin Level Display */
        .margin-display {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--dark-bg), #1f2937);
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
        }

        .margin-level {
            font-size: 48px;
            font-weight: 700;
            margin-right: 20px;
        }

        .margin-level.safe {
            color: var(--success-color);
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .margin-level.warning {
            color: var(--warning-color);
            text-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }

        .margin-level.danger {
            color: var(--danger-color);
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Step indicator improvements */
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary-light), white);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 3px;
            background: var(--border-color);
        }

        .step:last-child::after {
            display: none;
        }

        .step.completed::after {
            background: linear-gradient(90deg, var(--success-color), var(--success-hover));
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border-color);
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .step.completed .step-circle {
            background: linear-gradient(135deg, var(--success-color), var(--success-hover));
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
            animation: pulse 2s infinite;
        }

        .step-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .step.completed .step-label,
        .step.active .step-label {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Channel cards improvements */
        .channel-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
        }

        .channel-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            background: var(--primary-light);
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .channel-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .channel-actions {
            display: flex;
            gap: 10px;
        }

        /* Loading overlay improvements */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            box-shadow: var(--shadow-xl);
        }

        .loading-content h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        /* Breakeven Settings */
        .breakeven-settings {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, var(--success-color), var(--success-hover));
            color: white;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .breakeven-select {
            padding: 10px 15px;
            border: 2px solid white;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .breakeven-select option {
            background: var(--primary-color);
        }

        /* Validation styles */
        .validation-error {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
            font-weight: 500;
        }

        .validation-error.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Risk Management Dashboard */
        .risk-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .risk-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }

        .risk-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .risk-card-title {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .risk-card-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .risk-card.safe {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #F0FDF4, white);
        }

        .risk-card.warning {
            border-color: var(--warning-color);
            background: linear-gradient(135deg, #FFFBEB, white);
        }

        .risk-card.danger {
            border-color: var(--danger-color);
            background: linear-gradient(135deg, #FEF2F2, white);
        }

        /* Telethon Console Status */
        .telethon-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
        }

        .telethon-connected {
            background: linear-gradient(135deg, var(--success-color), var(--success-hover));
            color: white;
        }

        .telethon-disconnected {
            background: linear-gradient(135deg, #6B7280, #4B5563);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Trading Bot Pro - Enhanced Edition</h1>
            <p>Advanced Telegram Bot + Forwarder + Console + Risk Management</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'config')">⚙️ Konfiguracja</button>
            <button class="tab-button" onclick="openTab(event, 'profiles')">👤 Profile</button>
            <button class="tab-button" onclick="openTab(event, 'trading')">💼 Handel</button>
            <button class="tab-button" onclick="openTab(event, 'risk')">🛡️ Risk Management</button>
            <button class="tab-button" onclick="openTab(event, 'signals')">📊 Sygnały</button>
            <button class="tab-button" onclick="openTab(event, 'telegram')">🤖 Telegram Bot</button>
            <button class="tab-button" onclick="openTab(event, 'forwarder')">📡 Forwarder</button>
            <button class="tab-button" onclick="openTab(event, 'console')">💻 Console</button>
            <button class="tab-button" onclick="openTab(event, 'positions')">🎯 Pozycje</button>
            <button class="tab-button" onclick="openTab(event, 'logs')">📝 Logi</button>
        </div>

        <!-- Config Tab -->
        <div id="config" class="tab-content active">
            <div class="section">
                <h2 class="section-title">⚙️ KONFIGURACJA API</h2>

                <div class="alert alert-info">
                    <div>
                        <strong>🚨 WAŻNE: Demo Trading Setup</strong><br>
                        1. Przejdź na: testnet.bybit.com → Assets → Derivatives → API<br>
                        2. Utwórz nowe klucze API z uprawnieniami: Read + Trade<br>
                        3. System obsługuje persistent sessions - logowanie 2FA tylko raz!
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🏛️ Bybit API Configuration</h3>

                    <div class="form-group">
                        <label>Trading Platform:</label>
                        <div class="radio-group">
                            <div class="radio-wrapper">
                                <input type="radio" id="platform-testnet" name="platform" value="testnet" checked>
                                <label for="platform-testnet">🎮 Testnet (Demo)</label>
                            </div>
                            <div class="radio-wrapper">
                                <input type="radio" id="platform-mainnet" name="platform" value="mainnet">
                                <label for="platform-mainnet">💰 Mainnet (Live)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Position Mode:</label>
                        <div class="radio-group">
                            <div class="radio-wrapper">
                                <input type="radio" id="mode-oneway" name="position-mode" value="one_way" checked>
                                <label for="mode-oneway">🎯 One Way Mode</label>
                            </div>
                            <div class="radio-wrapper">
                                <input type="radio" id="mode-hedge" name="position-mode" value="hedge">
                                <label for="mode-hedge">⚔️ Hedge Mode</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="api-key">🔑 API Key:</label>
                        <input type="text" id="api-key" class="form-control" placeholder="Wprowadź API Key z testnet.bybit.com">
                    </div>

                    <div class="form-group">
                        <label for="api-secret">🔐 API Secret:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="password" id="api-secret" class="form-control" placeholder="Wprowadź API Secret" style="flex: 1;">
                            <label class="checkbox-wrapper" style="margin: 0; padding: 8px 16px;">
                                <input type="checkbox" id="show-secret" onchange="toggleSecret()">
                                <span>👁️ Pokaż</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="subaccount">🏢 Subkonto (opcjonalnie):</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="subaccount" class="form-control" style="flex: 1;">
                                <option value="">Główne konto</option>
                            </select>
                            <button class="btn btn-info" onclick="loadSubaccounts()">🔄 Pobierz Subkonta</button>
                        </div>
                    </div>

                    <div id="api-status" class="alert alert-info">
                        🔌 Status: Nie sprawdzono połączenia
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🤖 Telegram Configuration</h3>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="telegram-token">Bot Token:</label>
                            <input type="text" id="telegram-token" class="form-control" placeholder="Token z @BotFather">
                        </div>
                        <div class="form-group">
                            <label for="telegram-chat-id">Chat ID:</label>
                            <input type="text" id="telegram-chat-id" class="form-control" placeholder="Twój Chat ID">
                        </div>
                    </div>
                </div>

                <div>
                    <button class="btn btn-success" onclick="saveConfig()">💾 Zapisz Konfigurację</button>
                    <button class="btn btn-primary" onclick="testConnection()">🧪 Test Połączenia</button>
                </div>
            </div>
        </div>

        <!-- Risk Management Tab -->
        <div id="risk" class="tab-content">
            <div class="section">
                <h2 class="section-title">🛡️ RISK MANAGEMENT & SAFETY</h2>

                <!-- Risk Dashboard -->
                <div class="risk-dashboard">
                    <div class="risk-card" id="daily-loss-card">
                        <div class="risk-card-title">Dzienna Strata</div>
                        <div class="risk-card-value" id="daily-loss-value">$0.00</div>
                        <div class="risk-card-subtitle">Limit: $<span id="daily-limit-display">500</span></div>
                        <div class="risk-bar">
                            <div class="risk-bar-fill safe" id="daily-loss-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="risk-card" id="weekly-loss-card">
                        <div class="risk-card-title">Tygodniowa Strata</div>
                        <div class="risk-card-value" id="weekly-loss-value">$0.00</div>
                        <div class="risk-card-subtitle">Limit: $<span id="weekly-limit-display">2000</span></div>
                        <div class="risk-bar">
                            <div class="risk-bar-fill safe" id="weekly-loss-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="risk-card" id="consecutive-card">
                        <div class="risk-card-title">Straty z Rzędu</div>
                        <div class="risk-card-value" id="consecutive-value">0</div>
                        <div class="risk-card-subtitle">Max: <span id="consecutive-limit-display">3</span></div>
                        <div class="risk-bar">
                            <div class="risk-bar-fill safe" id="consecutive-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="risk-card" id="margin-card">
                        <div class="risk-card-title">Margin Level</div>
                        <div class="risk-card-value" id="margin-value">--</div>
                        <div class="risk-card-subtitle">Min: <span id="margin-limit-display">1.5</span></div>
                        <div class="risk-bar">
                            <div class="risk-bar-fill safe" id="margin-bar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">⚙️ Ustawienia Limitów</h3>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="risk-management-enabled" checked>
                        <label for="risk-management-enabled">🛡️ Włącz Risk Management (ZALECANE)</label>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="daily-loss-limit">💔 Dzienny Limit Strat ($):</label>
                            <input type="number" id="daily-loss-limit" class="form-control" value="500" min="0" step="50">
                            <small style="color: var(--text-secondary);">Bot przestanie handlować po osiągnięciu tego limitu</small>
                        </div>

                        <div class="form-group">
                            <label for="weekly-loss-limit">📅 Tygodniowy Limit Strat ($):</label>
                            <input type="number" id="weekly-loss-limit" class="form-control" value="2000" min="0" step="100">
                            <small style="color: var(--text-secondary);">Maksymalna strata w tygodniu</small>
                        </div>

                        <div class="form-group">
                            <label for="max-consecutive-losses">🔴 Max Straty z Rzędu:</label>
                            <input type="number" id="max-consecutive-losses" class="form-control" value="3" min="1" max="10">
                            <small style="color: var(--text-secondary);">Cooling period po X stratach z rzędu</small>
                        </div>

                        <div class="form-group">
                            <label for="min-margin-level">⚠️ Min Margin Level:</label>
                            <input type="number" id="min-margin-level" class="form-control" value="1.5" min="1.1" max="5" step="0.1">
                            <small style="color: var(--text-secondary);">Chroni przed likwidacją (zalecane: 1.5-2.0)</small>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <strong>🔒 Zabezpieczenia:</strong><br>
                        • Bot automatycznie przestanie otwierać pozycje przy niskim margin level<br>
                        • Po 3 stratach z rzędu - 1 godzina cooling period<br>
                        • Limity resetują się automatycznie o północy (dzienne) i w poniedziałek (tygodniowe)<br>
                        • System zapisuje historię transakcji dla analizy
                    </div>

                    <button class="btn btn-success" onclick="saveRiskSettings()">💾 Zapisz Ustawienia Risk Management</button>
                    <button class="btn btn-warning" onclick="resetRiskLimits()">🔄 Reset Limitów</button>
                    <button class="btn btn-info" onclick="checkMarginLevel()">📊 Sprawdź Margin Level</button>
                </div>
            </div>
        </div>

        <!-- Profiles Tab -->
        <div id="profiles" class="tab-content">
            <div class="section">
                <h2 class="section-title">👤 ZARZĄDZANIE PROFILAMI</h2>

                <div class="section">
                    <h3 class="section-title">💾 Zapisz Obecną Konfigurację</h3>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label for="profile-name">Nazwa Profilu:</label>
                            <input type="text" id="profile-name" class="form-control" placeholder="np. Demo Trading, Live Small, etc.">
                        </div>
                        <button class="btn btn-success" onclick="saveProfile()">💾 Zapisz Profil</button>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">📋 Zapisane Profile</h3>
                    <div class="scrollable-frame">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nazwa</th>
                                    <th>Data</th>
                                    <th>Platforma</th>
                                    <th>Tryb</th>
                                    <th>Risk Mgmt</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody id="profiles-list">
                                <!-- Profiles will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="refreshProfiles()">🔄 Odśwież Liste</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Tab -->
        <div id="trading" class="tab-content">
            <div class="section">
                <h2 class="section-title">💼 USTAWIENIA HANDLOWE</h2>

                <div class="section">
                    <h3 class="section-title">⚙️ Parametry Pozycji</h3>

                    <div class="grid-2">
                        <div>
                            <div class="form-group">
                                <label for="leverage">⚔️ Dźwignia (Leverage):</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="leverage" class="form-control" value="10" min="1" max="100" style="width: 100px;">
                                    <span style="font-weight: 600;">x</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>💰 Typ Kwoty:</label>
                                <div class="radio-group" style="flex-direction: column;">
                                    <div class="radio-wrapper">
                                        <input type="radio" id="amount-fixed" name="amount-type" value="fixed" checked onchange="updateAmountType()">
                                        <label for="amount-fixed">💵 Stała kwota USDT</label>
                                    </div>
                                    <div class="radio-wrapper">
                                        <input type="radio" id="amount-percentage" name="amount-type" value="percentage" onchange="updateAmountType()">
                                        <label for="amount-percentage">📊 Procent portfela</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="form-group">
                                <label for="amount">💵 Kwota/Procent:</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input type="number" id="amount" class="form-control" value="100" min="0" step="0.01" style="width: 150px;">
                                    <span id="amount-label" style="font-weight: 600;">USDT</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>📊 Kalkulacja na żywo:</label>
                                <div id="calculations" class="alert alert-info">
                                    Wprowadź parametry aby zobaczyć obliczenia
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🛡️ Zarządzanie Ryzykiem</h3>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="max-position">💎 Max Wielkość Pozycji:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" id="max-position" class="form-control" value="1000" min="0" step="1" style="width: 150px;">
                                <span style="font-weight: 600;">USDT</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="risk-percent">⚠️ Max Ryzyko na Trade:</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" id="risk-percent" class="form-control" value="2" min="0" max="100" step="0.1" style="width: 100px;">
                                <span style="font-weight: 600;">% portfela</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🎮 Tryb Handlu</h3>

                    <div class="radio-group" style="flex-direction: column;">
                        <div class="radio-wrapper">
                            <input type="radio" id="mode-demo" name="trading-mode" value="demo" checked>
                            <label for="mode-demo">🎮 Demo Trading (Testnet)</label>
                        </div>
                        <div class="radio-wrapper">
                            <input type="radio" id="mode-live" name="trading-mode" value="live">
                            <label for="mode-live">💰 Live Trading (Prawdziwe $)</label>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🎯 Automatyczne TP/SL & Breakeven</h3>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="auto-tp-sl" checked>
                        <label for="auto-tp-sl">🎯 Auto ustawianie Take Profit i Stop Loss</label>
                    </div>

                    <div class="breakeven-settings">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="checkbox" id="auto-breakeven" checked>
                            <label for="auto-breakeven" style="margin: 0;">💡 Auto przesuwanie SL do breakeven po osiągnięciu targetu:</label>
                            <select id="breakeven-target" class="breakeven-select">
                                <option value="1" selected>TP1 (Pierwszy Target)</option>
                                <option value="2">TP2 (Drugi Target)</option>
                                <option value="3">TP3 (Trzeci Target)</option>
                                <option value="4">TP4 (Czwarty Target)</option>
                            </select>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        ✨ <strong>ENHANCED AUTO BREAKEVEN:</strong><br>
                        • Wybierz po którym targecie aktywować breakeven (TP1-TP4)<br>
                        • System automatycznie przesunie Stop Loss do ceny wejścia<br>
                        • Zabezpiecza pozycję przed stratą po osiągnięciu zysku<br>
                        • Działa w czasie rzeczywistym - monitoring co 15 sekund<br>
                        • Powiadomienia Telegram o aktywacji breakeven
                    </div>

                    <button class="btn btn-success" onclick="saveTradingSettings()" style="margin-top: 15px;">💾 Zapisz Ustawienia Handlowe</button>
                </div>

                <div class="section">
                    <h3 class="section-title">💰 Saldo Konta</h3>
                    <button class="btn btn-primary" onclick="refreshBalance()">🔄 Odśwież Saldo</button>
                    <div id="balance-info" class="alert alert-info" style="margin-top: 10px;">
                        💡 Kliknij 'Odśwież' aby pobrać aktualne saldo
                    </div>
                </div>
            </div>
        </div>

        <!-- Signals Tab -->
        <div id="signals" class="tab-content">
            <div class="section">
                <h2 class="section-title">📊 ANALIZA SYGNAŁÓW</h2>

                <div class="section">
                    <h3 class="section-title">📥 Wklej Sygnał do Analizy</h3>
                    <textarea id="signal-input" class="form-control" rows="10" style="font-family: 'Monaco', 'Menlo', monospace;">📩 #BTCUSDT 30m | Mid-Term
📉 Long Entry Zone: 43007-42769
🎯 - Strategy Accuracy:  89%
⏳ - Signal details:
Target 1:  43297
Target 2:  43587
Target 3:  43878
Target 4:  44548
_____
🧲Trend-Line: 42769
⌛Stop-Loss: 41829
💡After reaching the first target you can put the rest of the position to breakeven</textarea>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="analyzeSignal()">🔍 Analizuj Sygnał</button>
                        <button id="execute-signal-btn" class="btn btn-success" onclick="executeSignal()" disabled>🚀 Wykonaj Trade</button>
                        <button class="btn btn-danger" onclick="clearSignal()">🗑️ Wyczyść</button>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">📊 Wynik Analizy</h3>
                    <div id="signal-result" class="console" style="height: auto; min-height: 200px;">
                        <!-- Signal analysis will appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Telegram Bot Tab -->
        <div id="telegram" class="tab-content">
            <div class="section">
                <h2 class="section-title">🤖 TELEGRAM BOT</h2>

                <div class="section">
                    <h3 class="section-title">📊 Status Bota</h3>
                    <div id="telegram-status" class="status-badge status-offline">
                        🔴 Bot Nieaktywny
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🎮 Kontrola</h3>
                    <button class="btn btn-success" onclick="startTelegram()">▶️ Uruchom Bota</button>
                    <button class="btn btn-danger" onclick="stopTelegram()">⏹️ Zatrzymaj Bota</button>
                    <button class="btn btn-info" onclick="getChatId()">📱 Pobierz Chat ID</button>
                </div>

                <div class="section">
                    <h3 class="section-title">🤖 Auto-Trading</h3>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="auto-execute">
                        <label for="auto-execute">🚀 Automatyczne wykonywanie sygnałów z Telegram</label>
                    </div>

                    <div class="alert alert-warning">
                        ⚠️ <strong>UWAGA:</strong> Włączenie auto-tradingu spowoduje automatyczne wykonywanie<br>
                        wszystkich rozpoznanych sygnałów bez potwierdzenia! Używaj ostrożnie.
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">📋 Instrukcje Użycia</h3>
                    <div class="alert alert-info">
                        <strong>Jak używać Telegram Bota:</strong><br><br>
                        1. 🔑 Skonfiguruj Token i Chat ID w zakładce "Konfiguracja"<br>
                        2. 📱 Użyj "Pobierz Chat ID" aby automatycznie pobrać swój ID<br>
                        3. ▶️ Kliknij "Uruchom Bota" aby rozpocząć nasłuchiwanie<br>
                        4. 📨 Wyślij sygnał na Telegram - bot automatycznie go rozpozna<br>
                        5. 🤖 Włącz "Auto-Trading" dla automatycznego wykonywania (ostrożnie!)<br><br>

                        💡 <strong>TIPS:</strong><br>
                        • Bot rozpoznaje sygnały w standardowym formacie<br>
                        • Wszystkie akcje są logowane w zakładce "Logi"<br>
                        • Możesz testować sygnały ręcznie w zakładce "Sygnały"<br>
                        • Risk Management chroni przed nadmiernymi stratami
                    </div>
                </div>
            </div>
        </div>

        <!-- Forwarder Tab -->
        <div id="forwarder" class="tab-content">
            <div class="section">
                <h2 class="section-title">📡 TELEGRAM FORWARDER - Persistent Sessions</h2>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step" id="step-1">
                        <div class="step-circle">1</div>
                        <div class="step-label">API Setup</div>
                    </div>
                    <div class="step" id="step-2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Autoryzacja</div>
                    </div>
                    <div class="step" id="step-3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Wybór Kanałów</div>
                    </div>
                    <div class="step" id="step-4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Start</div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🔧 Krok 1: Telethon API Configuration</h3>

                    <div class="alert alert-success">
                        <strong>✨ ENHANCED: Persistent Sessions!</strong><br>
                        • System zapisuje sesję - logowanie 2FA tylko RAZ<br>
                        • Sesje są przechowywane w folderze telegram_sessions/<br>
                        • Po pierwszym logowaniu nie będziesz musiał podawać kodu ponownie<br>
                        • Nawet po restarcie aplikacji sesja pozostaje aktywna!
                    </div>

                    <div class="alert alert-info">
                        <strong>📋 JAK UZYSKAĆ API CREDENTIALS:</strong><br>
                        1. 🌐 Idź na <a href="https://my.telegram.org/apps" target="_blank">my.telegram.org/apps</a><br>
                        2. 📱 Zaloguj się swoim numerem telefonu<br>
                        3. ➕ Kliknij "Create new application"<br>
                        4. 📝 Wypełnij formularz (dowolna nazwa)<br>
                        5. 📋 Skopiuj <strong>API ID</strong> i <strong>API Hash</strong><br>
                        6. ✅ Wklej poniżej i zapisz
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label for="forwarder-api-id">📱 API ID:</label>
                            <input type="text" id="forwarder-api-id" class="form-control" placeholder="np. 12345678">
                            <small style="color: var(--text-secondary);">Numeryczny ID z my.telegram.org</small>
                            <div class="validation-error" id="api-id-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="forwarder-api-hash">🔐 API Hash:</label>
                            <input type="text" id="forwarder-api-hash" class="form-control" placeholder="32-znakowy hash">
                            <small style="color: var(--text-secondary);">Hash z my.telegram.org</small>
                            <div class="validation-error" id="api-hash-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="forwarder-phone">📞 Numer Telefonu:</label>
                            <input type="text" id="forwarder-phone" class="form-control" placeholder="+48123456789">
                            <small style="color: var(--text-secondary);">Z kodem kraju (np. +48 dla Polski)</small>
                            <div class="validation-error" id="phone-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="forwarder-target-chat">🎯 Docelowy Chat ID:</label>
                            <input type="text" id="forwarder-target-chat" class="form-control" placeholder="Opcjonalne - domyślnie używa Chat ID bota">
                            <small style="color: var(--text-secondary);">Zostaw puste dla domyślnego</small>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="saveForwarderConfig()">💾 Zapisz Konfigurację</button>
                        <span id="config-save-status" style="margin-left: 10px; color: var(--success-color); display: none; font-weight: 600;">✅ Zapisano!</span>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">🔍 Krok 2: Autoryzacja i Pobieranie Kanałów</h3>

                    <div class="alert alert-warning">
                        <strong>⚠️ WAŻNE:</strong> Najpierw zapisz konfigurację API powyżej!<br>
                        🔐 Przy pierwszym użyciu pojawi się prośba o kod z Telegram<br>
                        ✅ Kolejne połączenia NIE będą wymagały kodu (persistent session)
                    </div>

                    <button class="btn btn-info btn-lg" onclick="getChannels()" id="get-channels-btn">
                        📺 Pobierz Listę Kanałów
                    </button>

                    <div id="channels-loading" style="display: none; margin-top: 20px;">
                        <div class="loader"></div>
                        <p style="text-align: center; color: var(--text-secondary);">Łączenie z Telegram...</p>
                    </div>
                </div>

                <div class="section" id="channels-section" style="display: none;">
                    <h3 class="section-title">📺 Krok 3: Wybierz Kanały do Monitorowania</h3>

                    <div class="form-group">
                        <label>📋 Dostępne Kanały i Grupy:</label>
                        <div class="scrollable-frame" style="max-height: 400px;" id="available-channels-container">
                            <!-- Channel cards will be loaded here -->
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>👀 Aktualnie Monitorowane (<span id="monitored-count">0</span>):</label>
                        <div id="monitored-channels-list" style="min-height: 100px; background: var(--primary-light); border-radius: 10px; padding: 15px;">
                            <p style="color: var(--text-secondary); text-align: center;">Brak wybranych kanałów</p>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">⚙️ Krok 4: Opcje i Uruchomienie</h3>

                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="forward-all-messages">
                        <label for="forward-all-messages">📨 Przekazuj WSZYSTKIE wiadomości (nie tylko sygnały)</label>
                    </div>

                    <div class="alert alert-info">
                        <strong>💡 JAK TO DZIAŁA:</strong><br>
                        • Forwarder monitoruje wybrane kanały w czasie rzeczywistym<br>
                        • Automatycznie rozpoznaje sygnały tradingowe<br>
                        • Przekazuje sygnały do Twojego bota<br>
                        • Może automatycznie wykonywać handel (jeśli włączone)<br>
                        • Działa w tle - możesz zamknąć Telegram<br>
                        • <strong>Sesja jest zachowana - nie musisz logować się ponownie!</strong>
                    </div>

                    <div class="grid-2" style="margin-top: 20px;">
                        <div class="section">
                            <h4 class="section-title">📊 Status</h4>
                            <div id="forwarder-status" class="status-badge status-offline">
                                🔴 Forwarder Zatrzymany
                            </div>
                        </div>

                        <div class="section">
                            <h4 class="section-title">🎮 Kontrola</h4>
                            <button class="btn btn-success" onclick="startForwarder()" id="start-forwarder-btn">▶️ Start Forwarder</button>
                            <button class="btn btn-danger" onclick="stopForwarder()" id="stop-forwarder-btn">⏹️ Stop Forwarder</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Console Tab - ENHANCED WITH TELETHON CONNECTION -->
        <div id="console" class="tab-content">
            <div class="section">
                <h2 class="section-title">💻 DEVELOPER CONSOLE</h2>

                <div class="section">
                    <h3 class="section-title">🎮 Console Controls</h3>

                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-success" onclick="startConsoleRedirect()">🟢 Start Output</button>
                        <button class="btn btn-danger" onclick="stopConsoleRedirect()">🔴 Stop Output</button>
                        <button class="btn btn-warning" onclick="clearConsole()">🧹 Clear Console</button>
                        <button class="btn btn-info" onclick="exportConsoleLog()">💾 Export Log</button>

                        <!-- NEW TELETHON CONNECTION BUTTONS -->
                        <button class="btn btn-primary" onclick="connectTelethonConsole()" id="telethon-connect-btn">📱 Connect Telethon</button>
                        <button class="btn btn-danger" onclick="disconnectTelethonConsole()" id="telethon-disconnect-btn" style="display: none;">📴 Disconnect Telethon</button>
                        <span id="telethon-status" class="telethon-status telethon-disconnected">🔴 Telethon Offline</span>
                    </div>

                    <div id="console-status" class="alert alert-info" style="margin-top: 10px;">
                        🔴 Console Output: Inactive
                    </div>

                    <!-- NEW TELETHON INFO SECTION -->
                    <div id="telethon-info" class="alert alert-success" style="margin-top: 10px; display: none;">
                        <strong>📱 Telethon Connected!</strong><br>
                        <span id="telethon-session-info"></span>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">💻 Console Output</h3>

                    <div id="console-output" class="console">
                        <div class="console-success">[SYSTEM] 💻 Developer Console Ready</div>
                        <div class="console-info">[SYSTEM] 📋 Type 'help' for available commands</div>
                        <div class="console-info">[SYSTEM] 🚀 Enhanced features enabled</div>
                        <div class="console-telethon">[TELETHON] 📱 Click 'Connect Telethon' to establish Telegram connection</div>
                    </div>

                    <div class="console-input">
                        <span style="color: var(--success-color); font-family: 'Monaco', monospace;">$&gt; </span>
                        <input type="text" id="console-command" placeholder="Enter command..." onkeypress="handleConsoleKey(event)">
                        <button class="btn btn-primary" onclick="executeConsoleCommand()">⚡ Execute</button>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">📋 Available Commands</h3>

                    <pre style="background: linear-gradient(135deg, #f6f8fb, white); padding: 20px; border-radius: 10px; font-size: 13px; border: 1px solid var(--border-color);">
🔧 SYSTEM:
  • help - show available commands
  • clear - clear console
  • bot.balance - check account balance
  • bot.positions - show active positions
  • bot.test_api - test API connection

📊 RISK MANAGEMENT:
  • risk.status - show risk management status
  • risk.reset - reset daily/weekly limits
  • risk.margin - check current margin level

🔧 FORWARDER:
  • forwarder.status - forwarder status
  • forwarder.start - start forwarder
  • forwarder.stop - stop forwarder
  • forwarder.channels - list monitored channels

📱 TELETHON (NEW):
  • telethon.connect - connect to Telegram via Telethon
  • telethon.disconnect - disconnect from Telethon
  • telethon.status - check Telethon connection status
  • telethon.channels - list available channels via Telethon
  • telethon.session - show current session info
                    </pre>
                </div>
            </div>
        </div>

        <!-- Positions Tab -->
        <div id="positions" class="tab-content">
            <div class="section">
                <h2 class="section-title">🎯 ZARZĄDZANIE POZYCJAMI I BREAKEVEN</h2>

                <div class="section">
                    <h3 class="section-title">🎮 Panel Kontrolny</h3>

                    <button class="btn btn-primary" onclick="refreshPositions()">🔄 Odśwież Pozycje</button>
                    <button class="btn btn-success" onclick="startMonitoring()">🎯 Start Monitoring</button>
                    <button class="btn btn-danger" onclick="stopMonitoring()">🛑 Stop Monitoring</button>
                </div>

                <div class="section">
                    <h3 class="section-title">🔧 Ręczne Zarządzanie</h3>

                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label for="manual-symbol">Symbol:</label>
                            <input type="text" id="manual-symbol" class="form-control" placeholder="np. BTCUSDT">
                        </div>
                        <button class="btn btn-warning" onclick="manualBreakeven()">💡 Ustaw Breakeven</button>
                        <button class="btn btn-danger" onclick="removeFromMonitoring()">🗑️ Usuń z Monitoringu</button>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">📋 Aktywne Pozycje</h3>

                    <div class="scrollable-frame">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Typ</th>
                                    <th>Wejście</th>
                                    <th>Targety</th>
                                    <th>Breakeven</th>
                                    <th>Trigger</th>
                                    <th>Czas</th>
                                </tr>
                            </thead>
                            <tbody id="positions-list">
                                <!-- Positions will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="monitoring-status" class="status-badge status-offline" style="margin-top: 15px;">
                        🔴 Monitoring Nieaktywny
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="section">
                <h2 class="section-title">📝 LOGI SYSTEMOWE</h2>

                <div>
                    <button class="btn btn-primary" onclick="refreshLogs()">🔄 Odśwież Logi</button>
                    <button class="btn btn-danger" onclick="clearLogs()">🗑️ Wyczyść Logi</button>
                    <button class="btn btn-info" onclick="exportLogs()">💾 Eksportuj do Pliku</button>
                </div>

                <div class="section" style="margin-top: 15px;">
                    <h3 class="section-title">📄 Historia Działań</h3>
                    <div id="logs-output" class="console" style="height: 500px;">
                        <!-- Logs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔐 Autoryzacja Telegram</h2>
                <span class="modal-close" onclick="closeModal('authModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p id="auth-message" style="margin-bottom: 20px;">Wprowadź dane autoryzacyjne</p>
                <div class="form-group">
                    <input type="text" id="auth-input" class="form-control" placeholder="Wprowadź kod lub hasło" autocomplete="off">
                </div>
                <div id="auth-error" class="alert alert-danger" style="display: none; margin-top: 10px;"></div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitAuth()">✅ Potwierdź</button>
                    <button class="btn btn-danger" onclick="closeModal('authModal')">❌ Anuluj</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loader"></div>
            <h3 id="loading-title">Ładowanie...</h3>
            <p id="loading-message">Proszę czekać...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ============================
        // COMPLETE JAVASCRIPT CODE WITH TELETHON CONSOLE INTEGRATION
        // ============================

        // Global variables
        let config = {};
        let lastSignal = null;
        let currentBalance = null;
        let forwarderConfigured = false;
        let forwarderSteps = {
            config: false,
            auth: false,
            channels: false,
            running: false
        };
        let riskData = {
            daily_loss: 0,
            weekly_loss: 0,
            consecutive_losses: 0,
            margin_level: null
        };
        let telethonConnected = false;
        let telethonSessionInfo = {};

        // Socket.IO connection
        const socket = io();

        socket.on('connect', () => {
            console.log('✅ Connected to Socket.IO');
            socket.emit('request_status');
        });

        socket.on('status_update', (status) => {
            if (status.telegram_bot !== undefined) updateStatus('telegram', status.telegram_bot);
            if (status.forwarder !== undefined) updateStatus('forwarder', status.forwarder);
            if (status.monitoring !== undefined) updateMonitoringStatus(status.monitoring);
        });

        socket.on('console_message', (data) => {
            addConsoleMessage(data.message, data.level);
        });

        socket.on('auth_required', (data) => {
            showAuthModal(data.auth_type);
        });

        // NEW: Telethon console functions
        async function connectTelethonConsole() {
            try {
                addConsoleMessage('[TELETHON] 📱 Connecting to Telegram...', 'telethon');

                // Check if forwarder config exists
                const forwarderConfig = {
                    api_id: document.getElementById('forwarder-api-id').value.trim(),
                    api_hash: document.getElementById('forwarder-api-hash').value.trim(),
                    phone_number: document.getElementById('forwarder-phone').value.trim()
                };

                if (!forwarderConfig.api_id || !forwarderConfig.api_hash || !forwarderConfig.phone_number) {
                    addConsoleMessage('[TELETHON] ❌ Missing Telethon credentials! Configure in Forwarder tab first.', 'error');
                    showNotification('❌ Configure Telethon in Forwarder tab first!', 'error');
                    return;
                }

                // Execute telethon connect command
                const result = await apiRequest('console/command', 'POST', { command: 'telethon.connect' });

                if (result.success && result.message.includes('Connected')) {
                    telethonConnected = true;
                    updateTelethonStatus(true);
                    addConsoleMessage('[TELETHON] ✅ Successfully connected to Telegram!', 'success');

                    // Try to get session info
                    const sessionResult = await apiRequest('console/command', 'POST', { command: 'telethon.session' });
                    if (sessionResult.message) {
                        addConsoleMessage('[TELETHON] ' + sessionResult.message, 'telethon');
                        // Parse session info
                        if (sessionResult.message.includes('User:')) {
                            telethonSessionInfo = parseSessionInfo(sessionResult.message);
                            updateTelethonInfo(telethonSessionInfo);
                        }
                    }
                } else {
                    addConsoleMessage('[TELETHON] ❌ Failed to connect: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                addConsoleMessage('[TELETHON] ❌ Connection error: ' + error.message, 'error');
                console.error('Telethon connection error:', error);
            }
        }

        async function disconnectTelethonConsole() {
            try {
                addConsoleMessage('[TELETHON] 📴 Disconnecting from Telegram...', 'telethon');

                const result = await apiRequest('console/command', 'POST', { command: 'telethon.disconnect' });

                telethonConnected = false;
                updateTelethonStatus(false);
                addConsoleMessage('[TELETHON] ✅ Disconnected from Telegram', 'success');

                // Clear session info
                telethonSessionInfo = {};
                document.getElementById('telethon-info').style.display = 'none';
            } catch (error) {
                addConsoleMessage('[TELETHON] ❌ Disconnect error: ' + error.message, 'error');
            }
        }

        function updateTelethonStatus(connected) {
            const statusSpan = document.getElementById('telethon-status');
            const connectBtn = document.getElementById('telethon-connect-btn');
            const disconnectBtn = document.getElementById('telethon-disconnect-btn');

            if (connected) {
                statusSpan.className = 'telethon-status telethon-connected';
                statusSpan.textContent = '🟢 Telethon Online';
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'inline-block';
            } else {
                statusSpan.className = 'telethon-status telethon-disconnected';
                statusSpan.textContent = '🔴 Telethon Offline';
                connectBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'none';
            }
        }

        function parseSessionInfo(message) {
            // Parse session info from message
            const info = {};
            const userMatch = message.match(/User:\s*([^,]+)/);
            const phoneMatch = message.match(/Phone:\s*([^,]+)/);
            const idMatch = message.match(/ID:\s*([^,]+)/);

            if (userMatch) info.user = userMatch[1].trim();
            if (phoneMatch) info.phone = phoneMatch[1].trim();
            if (idMatch) info.id = idMatch[1].trim();

            return info;
        }

        function updateTelethonInfo(info) {
            const infoDiv = document.getElementById('telethon-info');
            const infoSpan = document.getElementById('telethon-session-info');

            if (info && Object.keys(info).length > 0) {
                let infoText = '';
                if (info.user) infoText += `User: ${info.user} `;
                if (info.phone) infoText += `| Phone: ${info.phone} `;
                if (info.id) infoText += `| ID: ${info.id}`;

                infoSpan.textContent = infoText;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Enhanced API request with better error handling
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`/api/${endpoint}`, options);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `API request failed: ${response.status}`);
                }

                return result;
            } catch (error) {
                console.error('API request error:', error);
                showNotification(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Tab handling with smooth transitions
        function openTab(evt, tabName) {
            const tabcontents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabcontents.length; i++) {
                tabcontents[i].classList.remove('active');
            }

            const tablinks = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active');
            }

            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');

            // Load tab-specific data
            loadTabData(tabName);
        }

        // Load tab-specific data
        function loadTabData(tabName) {
            switch (tabName) {
                case 'profiles':
                    refreshProfiles();
                    break;
                case 'positions':
                    refreshPositions();
                    break;
                case 'logs':
                    refreshLogs();
                    break;
                case 'forwarder':
                    updateForwarderSteps();
                    loadMonitoredChannels();
                    break;
                case 'risk':
                    loadRiskStats();
                    break;
                case 'config':
                    loadConfig();
                    break;
                case 'trading':
                    loadTradingSettings();
                    break;
            }
        }

        // Load initial configuration
        async function loadConfig() {
            try {
                const result = await apiRequest('config');
                config = result;

                // Populate form fields
                document.getElementById('telegram-token').value = result.telegram_token || '';
                document.getElementById('telegram-chat-id').value = result.telegram_chat_id || '';
                document.getElementById('api-key').value = result.bybit_api_key || '';
                document.getElementById('api-secret').value = result.bybit_api_secret || '';
                document.getElementById('subaccount').value = result.bybit_subaccount || '';

                // Set radio buttons
                if (result.use_demo_account) {
                    document.getElementById('platform-testnet').checked = true;
                } else {
                    document.getElementById('platform-mainnet').checked = true;
                }

                if (result.position_mode === 'hedge') {
                    document.getElementById('mode-hedge').checked = true;
                } else {
                    document.getElementById('mode-oneway').checked = true;
                }

                // Load forwarder config
                document.getElementById('forwarder-api-id').value = result.forwarder_api_id || '';
                document.getElementById('forwarder-api-hash').value = result.forwarder_api_hash || '';
                document.getElementById('forwarder-phone').value = result.forwarder_phone_number || '';
                document.getElementById('forwarder-target-chat').value = result.forwarder_target_chat_id || '';
                document.getElementById('forward-all-messages').checked = result.forward_all_messages || false;

            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Load trading settings
        async function loadTradingSettings() {
            try {
                const result = await apiRequest('config');

                document.getElementById('leverage').value = result.default_leverage || 10;
                document.getElementById('amount').value = result.default_amount || 100;
                document.getElementById('max-position').value = result.max_position_size || 1000;
                document.getElementById('risk-percent').value = result.risk_percent || 2;

                if (result.use_percentage) {
                    document.getElementById('amount-percentage').checked = true;
                } else {
                    document.getElementById('amount-fixed').checked = true;
                }

                if (result.use_demo_account) {
                    document.getElementById('mode-demo').checked = true;
                } else {
                    document.getElementById('mode-live').checked = true;
                }

                document.getElementById('auto-tp-sl').checked = result.auto_tp_sl !== false;
                document.getElementById('auto-breakeven').checked = result.auto_breakeven !== false;
                document.getElementById('breakeven-target').value = result.breakeven_after_target || 1;

                // Risk settings
                document.getElementById('risk-management-enabled').checked = result.risk_management_enabled !== false;
                document.getElementById('daily-loss-limit').value = result.daily_loss_limit || 500;
                document.getElementById('weekly-loss-limit').value = result.weekly_loss_limit || 2000;
                document.getElementById('max-consecutive-losses').value = result.max_consecutive_losses || 3;
                document.getElementById('min-margin-level').value = result.min_margin_level || 1.5;

                updateAmountType();
            } catch (error) {
                console.error('Error loading trading settings:', error);
            }
        }

        // Configuration functions
        async function saveConfig() {
            const configData = {
                telegram_token: document.getElementById('telegram-token').value.trim(),
                telegram_chat_id: document.getElementById('telegram-chat-id').value.trim(),
                bybit_api_key: document.getElementById('api-key').value.trim(),
                bybit_api_secret: document.getElementById('api-secret').value.trim(),
                bybit_subaccount: document.getElementById('subaccount').value.trim(),
                bybit_platform: document.querySelector('input[name="platform"]:checked').value === 'testnet' ? 'bybitglobal' : 'bybit',
                position_mode: document.querySelector('input[name="position-mode"]:checked').value,
                use_demo_account: document.querySelector('input[name="platform"]:checked').value === 'testnet'
            };

            try {
                const result = await apiRequest('config', 'POST', configData);
                showNotification('✅ Konfiguracja zapisana!', 'success');
                updateApiStatus('✅ Konfiguracja zapisana pomyślnie');
            } catch (error) {
                updateApiStatus('❌ Błąd zapisu konfiguracji');
            }
        }

        async function testConnection() {
            updateApiStatus('🔄 Testowanie połączenia...');

            try {
                const result = await apiRequest('test-connection', 'POST');
                const mode = result.demo ? 'DEMO (Testnet)' : 'LIVE';
                updateApiStatus(`✅ Połączono! Platform: ${result.platform} | Mode: ${mode}`);
                showNotification('🎉 Połączenie z Bybit pomyślne!', 'success');
            } catch (error) {
                updateApiStatus('❌ Błąd połączenia - sprawdź klucze API');
            }
        }

        async function loadSubaccounts() {
            try {
                const result = await apiRequest('subaccounts');
                const select = document.getElementById('subaccount');
                select.innerHTML = '<option value="">Główne konto</option>';

                result.subaccounts.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub.uid;
                    option.textContent = sub.display;
                    select.appendChild(option);
                });

                showNotification(`✅ Pobrano ${result.subaccounts.length} subkont`, 'success');
            } catch (error) {
                console.error('Error loading subaccounts:', error);
            }
        }

        function toggleSecret() {
            const input = document.getElementById('api-secret');
            const checkbox = document.getElementById('show-secret');
            input.type = checkbox.checked ? 'text' : 'password';
        }

        function updateApiStatus(message) {
            const statusEl = document.getElementById('api-status');
            statusEl.textContent = message;

            // Update alert class based on message
            statusEl.className = 'alert';
            if (message.includes('✅')) {
                statusEl.classList.add('alert-success');
            } else if (message.includes('❌')) {
                statusEl.classList.add('alert-danger');
            } else if (message.includes('🔄')) {
                statusEl.classList.add('alert-warning');
            } else {
                statusEl.classList.add('alert-info');
            }
        }

        // Risk Management Functions
        async function loadRiskStats() {
            try {
                const result = await apiRequest('risk-stats');
                if (result.success) {
                    updateRiskDisplay(result);
                }
            } catch (error) {
                console.error('Error loading risk stats:', error);
            }
        }

        function updateRiskDisplay(stats) {
            // Update values
            riskData = stats;

            // Daily loss
            const dailyLoss = Math.abs(stats.daily_loss || 0);
            const dailyLimit = parseFloat(document.getElementById('daily-loss-limit').value) || 500;
            const dailyPercent = Math.min((dailyLoss / dailyLimit) * 100, 100);

            document.getElementById('daily-loss-value').textContent = `$${dailyLoss.toFixed(2)}`;
            document.getElementById('daily-limit-display').textContent = dailyLimit;
            document.getElementById('daily-loss-bar').style.width = `${dailyPercent}%`;

            // Update card class
            const dailyCard = document.getElementById('daily-loss-card');
            dailyCard.classList.remove('safe', 'warning', 'danger');
            if (dailyPercent < 50) {
                dailyCard.classList.add('safe');
                document.getElementById('daily-loss-bar').className = 'risk-bar-fill safe';
            } else if (dailyPercent < 80) {
                dailyCard.classList.add('warning');
                document.getElementById('daily-loss-bar').className = 'risk-bar-fill warning';
            } else {
                dailyCard.classList.add('danger');
                document.getElementById('daily-loss-bar').className = 'risk-bar-fill danger';
            }

            // Weekly loss
            const weeklyLoss = Math.abs(stats.weekly_loss || 0);
            const weeklyLimit = parseFloat(document.getElementById('weekly-loss-limit').value) || 2000;
            const weeklyPercent = Math.min((weeklyLoss / weeklyLimit) * 100, 100);

            document.getElementById('weekly-loss-value').textContent = `$${weeklyLoss.toFixed(2)}`;
            document.getElementById('weekly-limit-display').textContent = weeklyLimit;
            document.getElementById('weekly-loss-bar').style.width = `${weeklyPercent}%`;

            // Consecutive losses
            const consecutive = stats.consecutive_losses || 0;
            const consecutiveLimit = parseInt(document.getElementById('max-consecutive-losses').value) || 3;
            const consecutivePercent = Math.min((consecutive / consecutiveLimit) * 100, 100);

            document.getElementById('consecutive-value').textContent = consecutive;
            document.getElementById('consecutive-limit-display').textContent = consecutiveLimit;
            document.getElementById('consecutive-bar').style.width = `${consecutivePercent}%`;

            // Margin level
            if (stats.last_margin_check) {
                const marginLevel = stats.last_margin_check.margin_level || 0;
                const minMargin = parseFloat(document.getElementById('min-margin-level').value) || 1.5;

                document.getElementById('margin-value').textContent = marginLevel.toFixed(2);
                document.getElementById('margin-limit-display').textContent = minMargin.toFixed(1);

                const marginCard = document.getElementById('margin-card');
                marginCard.classList.remove('safe', 'warning', 'danger');

                if (marginLevel >= minMargin * 1.5) {
                    marginCard.classList.add('safe');
                    document.getElementById('margin-bar').className = 'risk-bar-fill safe';
                } else if (marginLevel >= minMargin) {
                    marginCard.classList.add('warning');
                    document.getElementById('margin-bar').className = 'risk-bar-fill warning';
                } else {
                    marginCard.classList.add('danger');
                    document.getElementById('margin-bar').className = 'risk-bar-fill danger';
                }
            }
        }

        async function saveRiskSettings() {
            const settings = {
                risk_management_enabled: document.getElementById('risk-management-enabled').checked,
                daily_loss_limit: parseFloat(document.getElementById('daily-loss-limit').value),
                weekly_loss_limit: parseFloat(document.getElementById('weekly-loss-limit').value),
                max_consecutive_losses: parseInt(document.getElementById('max-consecutive-losses').value),
                min_margin_level: parseFloat(document.getElementById('min-margin-level').value)
            };

            try {
                await apiRequest('trading-settings', 'POST', settings);
                showNotification('✅ Risk Management settings saved!', 'success');
                loadRiskStats();
            } catch (error) {
                console.error('Error saving risk settings:', error);
            }
        }

        async function resetRiskLimits() {
            if (!confirm('Reset daily and weekly loss limits?')) return;

            try {
                await apiRequest('console/command', 'POST', { command: 'risk.reset' });
                showNotification('✅ Risk limits reset', 'success');
                loadRiskStats();
            } catch (error) {
                console.error('Error resetting limits:', error);
            }
        }

        async function checkMarginLevel() {
            try {
                const result = await apiRequest('console/command', 'POST', { command: 'risk.margin' });
                showNotification(result.message, 'info');
                loadRiskStats();
            } catch (error) {
                console.error('Error checking margin:', error);
            }
        }

        // Profile functions
        async function saveProfile() {
            const name = document.getElementById('profile-name').value.trim();
            if (!name) {
                showNotification('❌ Wprowadź nazwę profilu', 'error');
                return;
            }

            try {
                await apiRequest('profiles', 'POST', { name });
                showNotification(`✅ Profil '${name}' zapisany!`, 'success');
                document.getElementById('profile-name').value = '';
                refreshProfiles();
            } catch (error) {
                console.error('Error saving profile:', error);
            }
        }

        async function refreshProfiles() {
            try {
                const result = await apiRequest('profiles');
                const tbody = document.getElementById('profiles-list');
                tbody.innerHTML = '';

                Object.entries(result.profiles).forEach(([name, data]) => {
                    const row = tbody.insertRow();
                    const riskEnabled = data.config.risk_management_enabled ? '✅' : '❌';
                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${formatDate(data.timestamp)}</td>
                        <td>${data.config.bybit_platform === 'testnet' ? '🎮 Testnet' : '💰 Mainnet'}</td>
                        <td>${data.config.use_demo_account ? '🎮 Demo' : '💰 Live'}</td>
                        <td>${riskEnabled}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="loadProfile('${name}')">📥 Wczytaj</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProfile('${name}')">🗑️ Usuń</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }

        async function loadProfile(name) {
            if (!confirm(`Wczytać profil '${name}'?`)) return;

            try {
                await apiRequest(`profiles/${name}/load`, 'POST');
                showNotification(`✅ Profil '${name}' wczytany!`, 'success');
                await loadConfig();
                await loadTradingSettings();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function deleteProfile(name) {
            if (!confirm(`Usunąć profil '${name}'?`)) return;

            try {
                await apiRequest(`profiles/${name}`, 'DELETE');
                showNotification(`✅ Profil '${name}' usunięty!`, 'success');
                refreshProfiles();
            } catch (error) {
                console.error('Error deleting profile:', error);
            }
        }

        // Trading functions
        function updateAmountType() {
            const isPercentage = document.getElementById('amount-percentage').checked;
            document.getElementById('amount-label').textContent = isPercentage ? '%' : 'USDT';
            updateCalculations();
        }

        async function updateCalculations() {
            const leverage = parseFloat(document.getElementById('leverage').value) || 10;
            const amount = parseFloat(document.getElementById('amount').value) || 100;
            const usePercentage = document.getElementById('amount-percentage').checked;
            const maxPosition = parseFloat(document.getElementById('max-position').value) || 1000;
            const riskPercent = parseFloat(document.getElementById('risk-percent').value) || 2;

            if (!currentBalance) {
                document.getElementById('calculations').innerHTML = '❌ Brak połączenia - nie można obliczyć';
                return;
            }

            const availableBalance = currentBalance.totalAvailableBalance || 0;

            if (availableBalance <= 0) {
                document.getElementById('calculations').innerHTML = '❌ Brak salda - nie można obliczyć';
                return;
            }

            let marginAmount;
            let amountDisplay;

            if (usePercentage) {
                marginAmount = availableBalance * (amount / 100);
                amountDisplay = `${amount}% z ${availableBalance.toFixed(2)} USDT`;
            } else {
                marginAmount = Math.min(amount, availableBalance);
                amountDisplay = `${amount} USDT`;
            }

            let positionValue = marginAmount * leverage;
            let limitedByMax = '';

            if (positionValue > maxPosition) {
                positionValue = maxPosition;
                marginAmount = maxPosition / leverage;
                limitedByMax = ` (ograniczone do ${maxPosition} USDT)`;
            }

            const maxRiskAmount = availableBalance * (riskPercent / 100);
            const examplePrice = 50000;
            const exampleQty = positionValue / examplePrice;

            const calcText = `
                💰 <strong>Marża:</strong> ${marginAmount.toFixed(2)} USDT (${amountDisplay})<br>
                📈 <strong>Wartość pozycji:</strong> ${positionValue.toFixed(2)} USDT (leverage ${leverage}x)${limitedByMax}<br>
                🛡️ <strong>Max ryzyko:</strong> ${maxRiskAmount.toFixed(2)} USDT (${riskPercent}% portfela)<br>
                📊 <strong>Przykład:</strong> Dla BTC @ $50,000 = ${exampleQty.toFixed(6)} BTC<br>
                💼 <strong>Dostępne saldo:</strong> ${availableBalance.toFixed(2)} USDT
            `;

            document.getElementById('calculations').innerHTML = calcText;
        }

        async function saveTradingSettings() {
            const settings = {
                default_leverage: parseInt(document.getElementById('leverage').value),
                default_amount: parseFloat(document.getElementById('amount').value),
                use_percentage: document.getElementById('amount-percentage').checked,
                use_demo_account: document.getElementById('mode-demo').checked,
                auto_tp_sl: document.getElementById('auto-tp-sl').checked,
                auto_breakeven: document.getElementById('auto-breakeven').checked,
                breakeven_after_target: parseInt(document.getElementById('breakeven-target').value),
                max_position_size: parseFloat(document.getElementById('max-position').value),
                risk_percent: parseFloat(document.getElementById('risk-percent').value)
            };

            try {
                await apiRequest('trading-settings', 'POST', settings);
                showNotification('✅ Ustawienia handlowe zapisane!', 'success');
            } catch (error) {
                console.error('Error saving trading settings:', error);
            }
        }

        async function refreshBalance() {
            document.getElementById('balance-info').innerHTML = '🔄 Pobieranie salda...';

            try {
                const result = await apiRequest('balance');

                if (result && result.success) {
                    currentBalance = result;

                    const platform = config.bybit_platform === 'testnet' ? 'testnet.bybit.com' : 'bybit.com';
                    const mode = config.use_demo_account ? '🎮 DEMO' : '💰 LIVE';
                    const subaccountInfo = config.bybit_subaccount ? `<br>🏢 Subkonto: ${config.bybit_subaccount}` : '';

                    const info = `
                        ✅ <strong>${mode}</strong> - ${platform}${subaccountInfo}<br>
                        💰 <strong>Total Margin:</strong> ${result.totalMarginBalance.toFixed(2)} USDT<br>
                        🏦 <strong>Wallet Balance:</strong> ${result.totalWalletBalance.toFixed(2)} USDT<br>
                        💵 <strong>Available:</strong> ${result.totalAvailableBalance.toFixed(2)} USDT<br>
                        📊 <strong>Account Type:</strong> ${result.accountType}
                    `;

                    document.getElementById('balance-info').innerHTML = info;
                    updateCalculations();
                } else {
                    document.getElementById('balance-info').innerHTML = `❌ Nie można pobrać salda - sprawdź konfigurację API`;
                }
            } catch (error) {
                document.getElementById('balance-info').innerHTML = `❌ Błąd: ${error.message}`;
            }
        }

        // Signal functions
        async function analyzeSignal() {
            const signalText = document.getElementById('signal-input').value.trim();
            if (!signalText) {
                showNotification('⚠️ Wprowadź sygnał', 'warning');
                return;
            }

            try {
                const result = await apiRequest('analyze-signal', 'POST', { signal: signalText });

                if (result.signal) {
                    lastSignal = result.signal;
                    displaySignalAnalysis(result.signal, result.analysis);
                    document.getElementById('execute-signal-btn').disabled = false;
                } else {
                    document.getElementById('signal-result').innerHTML = '<div class="console-error">❌ Nie rozpoznano sygnału</div>';
                    document.getElementById('execute-signal-btn').disabled = true;
                }
            } catch (error) {
                document.getElementById('signal-result').innerHTML = `<div class="console-error">❌ Błąd analizy: ${error.message}</div>`;
            }
        }

        function displaySignalAnalysis(signal, analysis) {
            let html = `
                <div class="console-success">✅ SYGNAŁ ROZPOZNANY!</div>
                <div style="color: #74C0FC;">${'='.repeat(50)}</div><br>
                <div class="console-info">
                📊 <strong>Symbol:</strong> ${signal.symbol}<br>
                📈 <strong>Typ:</strong> ${signal.position_type.toUpperCase()}<br>
                💰 <strong>Wejście:</strong> ${signal.entry_price}<br>
                🛑 <strong>Stop Loss:</strong> ${signal.stop_loss || 'Brak'}<br>
                🎯 <strong>Targety:</strong> ${Object.keys(signal.targets).length}<br><br>
                </div>
            `;

            if (signal.targets && Object.keys(signal.targets).length > 0) {
                html += '<div class="console-warning">🎯 TARGETS:</div>';
                Object.entries(signal.targets).forEach(([num, price]) => {
                    html += `<div class="console-info">   Target ${num}: ${price}</div>`;
                });
                html += '<br>';
            }

            html += `<div class="console-debug">${analysis.replace(/\n/g, '<br>')}</div>`;

            document.getElementById('signal-result').innerHTML = html;
        }

        async function executeSignal() {
            if (!lastSignal) {
                showNotification('❌ Brak sygnału do wykonania', 'error');
                return;
            }

            const mode = document.getElementById('mode-demo').checked ? '🎮 DEMO' : '💰 LIVE';
            const autoTpSl = document.getElementById('auto-tp-sl').checked ? 'Włączony' : 'Wyłączony';
            const breakeven = document.getElementById('auto-breakeven').checked;
            const breakevenTarget = document.getElementById('breakeven-target').value;

            const confirmMsg = `${mode} TRADING\n\n` +
                `📊 ${lastSignal.symbol} ${lastSignal.position_type.toUpperCase()}\n` +
                `💰 Wejście: ${lastSignal.entry_price}\n` +
                `🎯 Auto TP/SL: ${autoTpSl}\n` +
                `💡 Breakeven: ${breakeven ? `Po TP${breakevenTarget}` : 'Wyłączony'}\n\n` +
                `❓ Wykonać handel?`;

            if (!confirm(confirmMsg)) return;

            try {
                const result = await apiRequest('execute-trade', 'POST', { signal: lastSignal });
                showNotification(result.message, result.success ? 'success' : 'error');

                if (result.success) {
                    refreshPositions();
                    loadRiskStats();
                }
            } catch (error) {
                console.error('Error executing signal:', error);
            }
        }

        function clearSignal() {
            document.getElementById('signal-input').value = '';
            document.getElementById('signal-result').innerHTML = '';
            document.getElementById('execute-signal-btn').disabled = true;
            lastSignal = null;
        }

        // Telegram Bot functions
        async function startTelegram() {
            try {
                const autoExecute = document.getElementById('auto-execute').checked;

                await apiRequest('telegram/start', 'POST', { auto_execute: autoExecute });
                updateStatus('telegram', true);
                showNotification('✅ Bot Telegram uruchomiony!', 'success');
            } catch (error) {
                console.error('Error starting Telegram bot:', error);
            }
        }

        async function stopTelegram() {
            try {
                await apiRequest('telegram/stop', 'POST');
                updateStatus('telegram', false);
                showNotification('🛑 Bot Telegram zatrzymany', 'info');
            } catch (error) {
                console.error('Error stopping Telegram bot:', error);
            }
        }

        async function getChatId() {
            try {
                const result = await apiRequest('telegram/chat-id');

                if (result.chat_id) {
                    document.getElementById('telegram-chat-id').value = result.chat_id;
                    showNotification(`✅ Chat ID pobrane: ${result.chat_id}`, 'success');
                } else {
                    showNotification('❌ Nie znaleziono Chat ID', 'error');
                }
            } catch (error) {
                console.error('Error getting chat ID:', error);
            }
        }

        // Forwarder functions with validation
        function validateForwarderConfig() {
            let isValid = true;

            // Reset errors
            document.querySelectorAll('.validation-error').forEach(el => {
                el.textContent = '';
                el.classList.remove('show');
            });
            document.querySelectorAll('.form-control').forEach(el => {
                el.classList.remove('error');
            });

            // Validate API ID
            const apiId = document.getElementById('forwarder-api-id').value.trim();
            if (!apiId) {
                showFieldError('forwarder-api-id', 'api-id-error', 'API ID jest wymagane');
                isValid = false;
            } else if (!/^\d+$/.test(apiId)) {
                showFieldError('forwarder-api-id', 'api-id-error', 'API ID musi zawierać tylko cyfry');
                isValid = false;
            }

            // Validate API Hash
            const apiHash = document.getElementById('forwarder-api-hash').value.trim();
            if (!apiHash) {
                showFieldError('forwarder-api-hash', 'api-hash-error', 'API Hash jest wymagane');
                isValid = false;
            } else if (apiHash.length !== 32) {
                showFieldError('forwarder-api-hash', 'api-hash-error', 'API Hash musi mieć dokładnie 32 znaki');
                isValid = false;
            }

            // Validate phone number
            const phone = document.getElementById('forwarder-phone').value.trim();
            if (!phone) {
                showFieldError('forwarder-phone', 'phone-error', 'Numer telefonu jest wymagany');
                isValid = false;
            } else if (!/^\+\d{8,15}$/.test(phone)) {
                showFieldError('forwarder-phone', 'phone-error', 'Numer musi zaczynać się od + i zawierać 8-15 cyfr');
                isValid = false;
            }

            return isValid;
        }

        function showFieldError(fieldId, errorId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);

            field.classList.add('error');
            error.textContent = message;
            error.classList.add('show');
        }

        async function saveForwarderConfig() {
            if (!validateForwarderConfig()) {
                showNotification('❌ Popraw błędy w formularzu', 'error');
                return;
            }

            const config = {
                api_id: document.getElementById('forwarder-api-id').value.trim(),
                api_hash: document.getElementById('forwarder-api-hash').value.trim(),
                phone_number: document.getElementById('forwarder-phone').value.trim(),
                target_chat_id: document.getElementById('forwarder-target-chat').value.trim(),
                forward_all_messages: document.getElementById('forward-all-messages').checked
            };

            try {
                await apiRequest('forwarder/config', 'POST', config);
                showNotification('✅ Konfiguracja forwarderu zapisana!', 'success');

                // Show save status
                const statusSpan = document.getElementById('config-save-status');
                statusSpan.style.display = 'inline';
                setTimeout(() => {
                    statusSpan.style.display = 'none';
                }, 3000);

                // Update steps
                forwarderSteps.config = true;
                updateForwarderSteps();
            } catch (error) {
                console.error('Error saving forwarder config:', error);
            }
        }

        async function getChannels() {
            try {
                if (!validateForwarderConfig()) {
                    showNotification('❌ Najpierw popraw błędy w konfiguracji!', 'error');
                    return;
                }

                // Show loading
                showLoading('Pobieranie kanałów', 'Łączenie z Telegram...');
                document.getElementById('channels-loading').style.display = 'block';
                document.getElementById('get-channels-btn').disabled = true;

                const result = await apiRequest('forwarder/channels');

                if (result && result.success && result.channels) {
                    displayAvailableChannels(result.channels);
                    document.getElementById('channels-section').style.display = 'block';
                    showNotification(`✅ Pobrano ${result.channels.length} kanałów!`, 'success');

                    // Update steps
                    forwarderSteps.auth = true;
                    forwarderSteps.channels = true;
                    updateForwarderSteps();
                } else {
                    const errorMsg = result?.error || 'Nie udało się pobrać kanałów';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('Error getting channels:', error);
                if (error.message) {
                    showNotification(`❌ ${error.message}`, 'error');
                }
            } finally {
                hideLoading();
                document.getElementById('channels-loading').style.display = 'none';
                document.getElementById('get-channels-btn').disabled = false;
            }
        }

        function displayAvailableChannels(channels) {
            const container = document.getElementById('available-channels-container');
            container.innerHTML = '';

            if (channels.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Brak dostępnych kanałów</p>';
                return;
            }

            channels.forEach(channel => {
                const card = document.createElement('div');
                card.className = 'channel-card';
                card.innerHTML = `
                    <div class="channel-info">
                        <div class="channel-name">${channel.name}</div>
                        <div class="channel-meta">
                            ${channel.type} • ID: ${channel.id}
                            ${channel.username ? ` • @${channel.username}` : ''}
                            ${channel.participants !== 'Unknown' ? ` • ${channel.participants} użytkowników` : ''}
                        </div>
                    </div>
                    <div class="channel-actions">
                        <button class="btn btn-sm btn-success" onclick="addChannelToMonitoring('${channel.id}', '${channel.name.replace(/'/g, "\\'")}')">
                            ➕ Dodaj
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function addChannelToMonitoring(channelId, channelName) {
            try {
                channelId = String(channelId);

                const result = await apiRequest('forwarder/monitor', 'POST', {
                    channel_id: channelId,
                    channel_name: channelName
                });

                if (result && result.success) {
                    showNotification(`✅ Kanał '${channelName}' dodany!`, 'success');
                    loadMonitoredChannels();
                } else {
                    const errorMsg = result?.error || 'Nie udało się dodać kanału';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('Error adding channel:', error);
            }
        }

        async function loadMonitoredChannels() {
            try {
                const result = await apiRequest('forwarder/monitored');
                const container = document.getElementById('monitored-channels-list');
                const countSpan = document.getElementById('monitored-count');

                countSpan.textContent = result.channels.length;

                if (result.channels.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Brak wybranych kanałów</p>';
                    return;
                }

                container.innerHTML = '';
                result.channels.forEach((channel, index) => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border-color);';
                    div.innerHTML = `
                        <span style="font-weight: 500;">${channel.name}</span>
                        <button class="btn btn-sm btn-danger" onclick="removeChannelFromMonitoring(${index})">
                            ❌ Usuń
                        </button>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading monitored channels:', error);
            }
        }

        async function removeChannelFromMonitoring(index) {
            if (!confirm('Usunąć kanał z monitoringu?')) return;

            try {
                await apiRequest(`forwarder/monitor/${index}`, 'DELETE');
                showNotification('✅ Kanał usunięty', 'success');
                loadMonitoredChannels();
            } catch (error) {
                console.error('Error removing channel:', error);
            }
        }

        async function startForwarder() {
            try {
                showLoading('Uruchamianie Forwardera', 'Inicjalizacja...');

                const result = await apiRequest('forwarder/start', 'POST');

                if (result && result.success) {
                    updateStatus('forwarder', true);
                    showNotification('✅ Forwarder uruchomiony!', 'success');
                    forwarderSteps.running = true;
                    updateForwarderSteps();
                } else {
                    const errorMsg = result?.error || 'Nieznany błąd';
                    showNotification(`❌ ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('Error starting forwarder:', error);
                if (error.message) {
                    showNotification(`❌ ${error.message}`, 'error');
                }
            } finally {
                hideLoading();
            }
        }

        async function stopForwarder() {
            try {
                await apiRequest('forwarder/stop', 'POST');
                updateStatus('forwarder', false);
                showNotification('🛑 Forwarder zatrzymany', 'info');
                forwarderSteps.running = false;
                updateForwarderSteps();
            } catch (error) {
                console.error('Error stopping forwarder:', error);
            }
        }

        function updateForwarderSteps() {
            const steps = {
                1: forwarderSteps.config,
                2: forwarderSteps.auth,
                3: forwarderSteps.channels,
                4: forwarderSteps.running
            };

            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                stepElement.classList.remove('completed', 'active');

                if (steps[i]) {
                    stepElement.classList.add('completed');
                } else if (i === Object.values(steps).filter(v => v).length + 1) {
                    stepElement.classList.add('active');
                }
            }
        }

        // Console functions
        let consoleRedirectActive = false;

        function startConsoleRedirect() {
            consoleRedirectActive = true;
            updateConsoleStatus();
            addConsoleMessage('🟢 Console output redirection STARTED', 'success');
        }

        function stopConsoleRedirect() {
            consoleRedirectActive = false;
            updateConsoleStatus();
            addConsoleMessage('🔴 Console output redirection STOPPED', 'warning');
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
            addConsoleMessage('🧹 Console cleared', 'info');
        }

        async function exportConsoleLog() {
            const content = document.getElementById('console-output').innerText;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `console-log-${new Date().toISOString()}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
            addConsoleMessage('💾 Console log exported', 'success');
        }

        function updateConsoleStatus() {
            const status = consoleRedirectActive ?
                '🟢 Console Output: Active' : '🔴 Console Output: Inactive';
            document.getElementById('console-status').textContent = status;
        }

        function addConsoleMessage(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString('pl-PL');
            const consoleOutput = document.getElementById('console-output');
            const div = document.createElement('div');
            div.className = `console-${level}`;
            div.textContent = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        async function executeConsoleCommand() {
            const input = document.getElementById('console-command');
            const command = input.value.trim();

            if (!command) return;

            input.value = '';
            addConsoleMessage(`$> ${command}`, 'debug');

            // Handle special Telethon commands
            if (command === 'telethon.connect') {
                await connectTelethonConsole();
                return;
            } else if (command === 'telethon.disconnect') {
                await disconnectTelethonConsole();
                return;
            } else if (command === 'telethon.status') {
                const status = telethonConnected ? 'Connected' : 'Disconnected';
                addConsoleMessage(`[TELETHON] Status: ${status}`, 'telethon');
                if (telethonConnected && telethonSessionInfo.user) {
                    addConsoleMessage(`[TELETHON] User: ${telethonSessionInfo.user}`, 'telethon');
                }
                return;
            }

            try {
                const result = await apiRequest('console/command', 'POST', { command });
                if (result.message) {
                    if (result.message === 'clear_console') {
                        clearConsole();
                    } else {
                        addConsoleMessage(result.message, 'info');
                    }
                }
            } catch (error) {
                addConsoleMessage(`❌ Command error: ${error.message}`, 'error');
            }
        }

        function handleConsoleKey(event) {
            if (event.key === 'Enter') {
                executeConsoleCommand();
            }
        }

        // Position management functions
        async function refreshPositions() {
            try {
                const result = await apiRequest('positions');
                displayPositions(result.positions);
                updateMonitoringStatus(result.monitoring_active, result.positions.length);
            } catch (error) {
                console.error('Error refreshing positions:', error);
            }
        }

        function displayPositions(positions) {
            const tbody = document.getElementById('positions-list');
            tbody.innerHTML = '';

            if (positions.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="7" style="text-align: center; color: var(--text-secondary);">Brak aktywnych pozycji</td>';
                return;
            }

            positions.forEach(pos => {
                const row = tbody.insertRow();
                const breakevenStatus = pos.sl_breakeven ? '✅' : '⏳';
                row.innerHTML = `
                    <td>${pos.symbol}</td>
                    <td>${pos.type.toUpperCase()}</td>
                    <td>${pos.entry}</td>
                    <td>${pos.targets}</td>
                    <td>${breakevenStatus}</td>
                    <td>${pos.breakeven_trigger || 'TP1'}</td>
                    <td>${pos.created}</td>
                `;
            });
        }

        function updateMonitoringStatus(isActive, positionCount = 0) {
            const statusEl = document.getElementById('monitoring-status');
            if (isActive) {
                statusEl.className = 'status-badge status-online';
                statusEl.textContent = `🟢 Monitoring Aktywny (${positionCount} pozycji)`;
            } else {
                statusEl.className = 'status-badge status-offline';
                statusEl.textContent = '🔴 Monitoring Nieaktywny';
            }
        }

        async function startMonitoring() {
            try {
                await apiRequest('positions/monitoring/start', 'POST');
                showNotification('✅ Monitoring uruchomiony', 'success');
                refreshPositions();
            } catch (error) {
                console.error('Error starting monitoring:', error);
            }
        }

        async function stopMonitoring() {
            try {
                await apiRequest('positions/monitoring/stop', 'POST');
                showNotification('🛑 Monitoring zatrzymany', 'info');
                refreshPositions();
            } catch (error) {
                console.error('Error stopping monitoring:', error);
            }
        }

        async function manualBreakeven() {
            const symbol = document.getElementById('manual-symbol').value.trim().toUpperCase();
            if (!symbol) {
                showNotification('❌ Wprowadź symbol', 'error');
                return;
            }

            try {
                await apiRequest('positions/breakeven', 'POST', { symbol });
                showNotification(`✅ Breakeven ustawiony dla ${symbol}`, 'success');
                refreshPositions();
            } catch (error) {
                console.error('Error setting breakeven:', error);
            }
        }

        async function removeFromMonitoring() {
            const symbol = document.getElementById('manual-symbol').value.trim().toUpperCase();
            if (!symbol) {
                showNotification('❌ Wprowadź symbol', 'error');
                return;
            }

            if (!confirm(`Usunąć ${symbol} z monitoringu?`)) return;

            try {
                await apiRequest(`positions/${symbol}`, 'DELETE');
                showNotification(`✅ ${symbol} usunięty z monitoringu`, 'success');
                refreshPositions();
            } catch (error) {
                console.error('Error removing position:', error);
            }
        }

        // Logs functions
        async function refreshLogs() {
            try {
                const result = await apiRequest('logs');
                const output = document.getElementById('logs-output');

                if (result.logs && result.logs.length > 0) {
                    output.innerHTML = '';
                    result.logs.forEach(log => {
                        const div = document.createElement('div');
                        div.style.cssText = 'color: #E0E6ED; font-size: 13px; line-height: 1.5;';
                        div.textContent = log;
                        output.appendChild(div);
                    });
                    output.scrollTop = output.scrollHeight;
                } else {
                    output.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">Brak logów</div>';
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        async function clearLogs() {
            if (!confirm('Wyczyścić wszystkie logi?')) return;

            try {
                await apiRequest('logs', 'DELETE');
                showNotification('✅ Logi wyczyszczone', 'success');
                refreshLogs();
            } catch (error) {
                console.error('Error clearing logs:', error);
            }
        }

        async function exportLogs() {
            try {
                const result = await apiRequest('logs');
                if (result.logs) {
                    const content = result.logs.join('\n');
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `trading-bot-logs-${new Date().toISOString()}.txt`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showNotification('💾 Logi wyeksportowane', 'success');
                }
            } catch (error) {
                console.error('Error exporting logs:', error);
            }
        }

        // Status update functions
        function updateStatus(service, isOnline) {
            let statusEl;

            switch(service) {
                case 'telegram':
                    statusEl = document.getElementById('telegram-status');
                    if (isOnline) {
                        statusEl.className = 'status-badge status-online';
                        statusEl.textContent = '🟢 Bot Aktywny';
                    } else {
                        statusEl.className = 'status-badge status-offline';
                        statusEl.textContent = '🔴 Bot Nieaktywny';
                    }
                    break;

                case 'forwarder':
                    statusEl = document.getElementById('forwarder-status');
                    if (isOnline) {
                        statusEl.className = 'status-badge status-online';
                        statusEl.textContent = '🟢 Forwarder Aktywny';
                    } else {
                        statusEl.className = 'status-badge status-offline';
                        statusEl.textContent = '🔴 Forwarder Zatrzymany';
                    }
                    break;
            }
        }

        // Modal functions
        function showAuthModal(authType) {
            const modal = document.getElementById('authModal');
            const message = document.getElementById('auth-message');
            const input = document.getElementById('auth-input');

            input.value = '';

            if (authType === 'code') {
                message.textContent = '📱 Wprowadź kod weryfikacyjny z Telegram:';
                input.placeholder = 'Wprowadź 5-cyfrowy kod';
            } else if (authType === 'password') {
                message.textContent = '🔐 Wprowadź hasło 2FA:';
                input.placeholder = 'Wprowadź hasło';
                input.type = 'password';
            }

            modal.style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function submitAuth() {
            const authValue = document.getElementById('auth-input').value.trim();

            if (!authValue) {
                document.getElementById('auth-error').textContent = 'Wprowadź wartość';
                document.getElementById('auth-error').style.display = 'block';
                return;
            }

            try {
                await apiRequest('auth/submit', 'POST', { auth_value: authValue });
                closeModal('authModal');
                showNotification('✅ Autoryzacja wysłana', 'success');
            } catch (error) {
                document.getElementById('auth-error').textContent = 'Błąd autoryzacji';
                document.getElementById('auth-error').style.display = 'block';
            }
        }

        // Loading overlay functions
        function showLoading(title, message) {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-title').textContent = title;
            document.getElementById('loading-message').textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';

            let bgColor, borderColor;
            switch(type) {
                case 'success':
                    bgColor = 'linear-gradient(135deg, #F0FDF4, #DCFCE7)';
                    borderColor = 'var(--success-color)';
                    break;
                case 'error':
                    bgColor = 'linear-gradient(135deg, #FEF2F2, #FEE2E2)';
                    borderColor = 'var(--danger-color)';
                    break;
                case 'warning':
                    bgColor = 'linear-gradient(135deg, #FFFBEB, #FEF3C7)';
                    borderColor = 'var(--warning-color)';
                    break;
                default:
                    bgColor = 'linear-gradient(135deg, #EFF6FF, #DBEAFE)';
                    borderColor = 'var(--info-color)';
            }

            notification.style.background = bgColor;
            notification.style.borderLeftColor = borderColor;
            notification.innerHTML = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutNotification 0.3s ease-out';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Utility functions
        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('pl-PL') + ' ' + date.toLocaleTimeString('pl-PL');
        }

        // Window click event for modals
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Trading Bot Pro - Starting...');

            // Load initial configuration
            await loadConfig();

            // Load initial trading settings
            await loadTradingSettings();

            // Connect to Socket.IO is already done at the beginning

            console.log('✅ Application ready');
        });
    </script>
</body>
</html>